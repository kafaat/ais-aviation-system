name: PR Checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches: [main, develop]

jobs:
  # =============================================================================
  # Validate PR Title (Conventional Commits)
  # =============================================================================
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Types allowed in PR title
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require scope
          requireScope: false
          # Disable WIP check
          disallowScopes: |
            release
          # Subject pattern
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" should start with a lowercase letter.

  # =============================================================================
  # Size Label
  # =============================================================================
  size-label:
    name: Add Size Label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false
          message_if_xl: >
            This PR is quite large. Consider breaking it into smaller PRs
            for easier review.

  # =============================================================================
  # Check for Breaking Changes
  # =============================================================================
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for breaking change indicators
        run: |
          # Check if PR title or body contains breaking change indicators
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          if echo "$PR_TITLE" | grep -qE "!:|BREAKING CHANGE"; then
            echo "::warning::This PR contains breaking changes. Make sure to update the major version."
          fi

          if echo "$PR_BODY" | grep -qi "breaking change"; then
            echo "::warning::This PR body mentions breaking changes. Ensure documentation is updated."
          fi

  # =============================================================================
  # Dependency Review
  # =============================================================================
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD
          deny-licenses: GPL-3.0, AGPL-3.0

  # =============================================================================
  # Check PR Checklist
  # =============================================================================
  pr-checklist:
    name: Verify PR Checklist
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Check for required sections
            const requiredSections = [
              { name: 'Description', pattern: /## (description|summary|what)/i },
              { name: 'Testing', pattern: /## (test|testing|how to test)/i }
            ];

            const missing = [];
            for (const section of requiredSections) {
              if (!section.pattern.test(prBody)) {
                missing.push(section.name);
              }
            }

            if (missing.length > 0) {
              core.warning(`PR description is missing sections: ${missing.join(', ')}`);
              core.notice('Consider adding description and testing sections to your PR');
            }

            // Check for linked issues
            if (!prBody.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i) &&
                !prBody.match(/https:\/\/github\.com\/.*\/issues\/\d+/i)) {
              core.notice('Consider linking related issues in your PR description');
            }
