# Critical Path Integration Tests

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 26 ููุงูุฑ 2026  
**ุงูููู:** `server/__tests__/integration/critical-paths.test.ts`

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐู ุงูุงุฎุชุจุงุฑุงุช ุชุบุทู **ุงููุณุงุฑุงุช ุงูุญุฑุฌุฉ** ุงูุชู ูุฌุจ ุฃู ุชุนูู ุจุดูู ุตุญูุญ ูุจู ุฃู ูุดุฑ ููุฅูุชุงุฌ.

---

## โ ุงูุงุฎุชุจุงุฑุงุช ุงููููุฐุฉ

### Test 1: Complete Booking Flow โ

```
Search โ Book โ Pay โ Webhook Success โ Confirmed
```

**ุงูุฎุทูุงุช:**

1. ุฅูุดุงุก ุญุฌุฒ ุจุญุงูุฉ `pending`
2. ุฅูุดุงุก Payment Intent
3. ูุนุงูุฌุฉ webhook `payment_intent.succeeded`
4. ุชุญุฏูุซ ุงูุญุฌุฒ ุฅูู `confirmed`
5. ุฅูุดุงุก ููุฏ ูุงูู ูู Ledger

**ุงูุชุญูู:**

- โ ุญุงูุฉ ุงูุญุฌุฒ = `confirmed`
- โ ุญุงูุฉ ุงูุฏูุน = `paid`
- โ ููุฏ ูุงูู ููุฌูุฏ

---

### Test 2: Payment Failure โ

```
Pay Fail โ Booking FAILED
```

**ุงูุฎุทูุงุช:**

1. ุฅูุดุงุก ุญุฌุฒ ุจุญุงูุฉ `pending`
2. ูุญุงูุงุฉ ูุดู ุงูุฏูุน
3. ุชุญุฏูุซ ุงูุญุฌุฒ ุฅูู `failed`

**ุงูุชุญูู:**

- โ ุญุงูุฉ ุงูุญุฌุฒ = `failed`
- โ ุญุงูุฉ ุงูุฏูุน = `failed`

---

### Test 3: Webhook Deduplication โ

```
Webhook Duplication โ No Duplicate Ledger
```

**ุงูุฎุทูุงุช:**

1. ูุนุงูุฌุฉ webhook ุฃูู ูุฑุฉ
2. ุชุฎุฒูู ุงูุญุฏุซ ูุน `processed=true`
3. ูุญุงููุฉ ูุนุงูุฌุฉ ููุณ ุงูุญุฏุซ ูุฑุฉ ุฃุฎุฑู
4. ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ ุงููุงูู

**ุงูุชุญูู:**

- โ ุงูุญุฏุซ ุงูููุฑุฑ ูุง ููุนุงูุฌ
- โ ููุฏ ูุงูู ูุงุญุฏ ููุท

---

### Test 4: Cancel Before Payment โ

```
Cancel Before Payment โ CANCELLED
```

**ุงูุฎุทูุงุช:**

1. ุฅูุดุงุก ุญุฌุฒ ุจุญุงูุฉ `pending`
2. ุฅูุบุงุก ุงูุญุฌุฒ ูุจู ุงูุฏูุน
3. ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูููุฏ ูุงููุฉ

**ุงูุชุญูู:**

- โ ุญุงูุฉ ุงูุญุฌุฒ = `cancelled`
- โ ูุง ูููุฏ ูุงููุฉ

---

### Test 5: Refund Flow โ

```
Confirmed โ Refund โ REFUNDED
```

**ุงูุฎุทูุงุช:**

1. ุฅูุดุงุก ุญุฌุฒ ูุคูุฏ ููุฏููุน
2. ุฅูุดุงุก ููุฏ ูุงูู ููุฏูุน
3. ูุนุงูุฌุฉ ุทูุจ ุงูุงุณุชุฑุฏุงุฏ
4. ุฅูุดุงุก ููุฏ ูุงูู ููุงุณุชุฑุฏุงุฏ (ุณุงูุจ)
5. ุงูุชุญูู ูู ุชูุงุฒู ุงูุญุณุงุจ

**ุงูุชุญูู:**

- โ ุญุงูุฉ ุงูุญุฌุฒ = `cancelled`
- โ ุญุงูุฉ ุงูุฏูุน = `refunded`
- โ ูุฌููุน ุงููููุฏ ุงููุงููุฉ = 0

---

### Test 6: Idempotency โ

```
Same Key โ Same Response
Different Payload + Same Key โ Reject
```

**ุงูุฎุทูุงุช:**

1. ุฅูุดุงุก ุญุฌุฒ ูุน idempotency key
2. ูุญุงููุฉ ุฅูุดุงุก ุญุฌุฒ ุขุฎุฑ ุจููุณ ุงูููุชุงุญ
3. ุงูุชุญูู ูู ุฅุฑุฌุงุน ููุณ ุงูุญุฌุฒ
4. ูุญุงููุฉ ุฅูุดุงุก ุญุฌุฒ ูุฎุชูู ุจููุณ ุงูููุชุงุญ
5. ุงูุชุญูู ูู ุงูุฑูุถ

**ุงูุชุญูู:**

- โ ููุณ ุงูููุชุงุญ โ ููุณ ุงููุชูุฌุฉ
- โ ููุชุงุญ ููุฑุฑ ูุน ุจูุงูุงุช ูุฎุชููุฉ โ ุฑูุถ

---

### Test 7: State Machine Guards โ

```
Invalid Transitions โ Blocked
Valid Transitions โ Allowed
```

**ุงูุงูุชูุงูุงุช ุบูุฑ ุงููุณููุญุฉ:**

- `cancelled` โ `confirmed` โ
- `cancelled` โ `pending` โ
- `completed` โ `pending` โ
- `failed` โ `confirmed` โ

**ุงูุงูุชูุงูุงุช ุงููุณููุญุฉ:**

- `pending` โ `confirmed` โ
- `pending` โ `cancelled` โ
- `pending` โ `failed` โ
- `confirmed` โ `completed` โ
- `confirmed` โ `cancelled` โ

---

## ๐ ููููุฉ ุงูุชุดุบูู

```bash
# ุชุดุบูู ุฌููุน ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู
pnpm test server/__tests__/integration/

# ุชุดุบูู ุงุฎุชุจุงุฑ ูุญุฏุฏ
pnpm test server/__tests__/integration/critical-paths.test.ts

# ุชุดุบูู ูุน ุงูุชูุงุตูู
pnpm test --reporter=verbose server/__tests__/integration/
```

---

## ๐ ุงูุชุบุทูุฉ ุงููุทููุจุฉ

| ุงููุณุงุฑ          | ุงูุฃูููุฉ | ุงูุญุงูุฉ |
| --------------- | ------- | ------ |
| Booking Flow    | P0      | โ     |
| Payment Failure | P0      | โ     |
| Webhook De-dup  | P0      | โ     |
| Cancel Flow     | P0      | โ     |
| Refund Flow     | P0      | โ     |
| Idempotency     | P0      | โ     |
| State Guards    | P0      | โ     |

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ูุงุนุฏุฉ ุงูุจูุงูุงุช:** ุงูุงุฎุชุจุงุฑุงุช ุชุณุชุฎุฏู ูุงุนุฏุฉ ุจูุงูุงุช ุญููููุฉ (test database)
2. **Stripe:** ูุชู ูุญุงูุงุฉ Stripe API ูู ุงูุงุฎุชุจุงุฑุงุช
3. **ุงูุชูุธูู:** ูู ุงุฎุชุจุงุฑ ููุธู ุจูุงูุงุชู ุจุนุฏ ุงูุงูุชูุงุก
4. **ุงูุชุฑุชูุจ:** ุงูุงุฎุชุจุงุฑุงุช ูุณุชููุฉ ููููู ุชุดุบูููุง ุจุฃู ุชุฑุชูุจ

---

## ๐ ุงููุฑุงุฌุน

- [PRODUCTION_GRADE_IMPLEMENTATION_GUIDE.md](./PRODUCTION_GRADE_IMPLEMENTATION_GUIDE.md)
- [P0_P1_IMPLEMENTATION_COMPLETE.md](./P0_P1_IMPLEMENTATION_COMPLETE.md)
- [Vitest Documentation](https://vitest.dev/)
