# ØªÙ‚ÙŠÙŠÙ… Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª - AIS Aviation System

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 26 ÙŠÙ†Ø§ÙŠØ± 2026  
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 1.0.0  
**Ø§Ù„Ù‡Ø¯Ù:** ØªÙ‚ÙŠÙŠÙ… Ø¯Ù‚ÙŠÙ‚ Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© ØªÙ†ÙÙŠØ°ÙŠØ© ÙˆØ§Ø¶Ø­Ø©

---

## ğŸ¯ Ø§Ù„Ù‡Ø¯Ù

ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‚Ø§Ø¨Ù„ **Ù…Ø¹Ø§ÙŠÙŠØ± Ø¥Ø·Ù„Ø§Ù‚ ØªØ¬Ø§Ø±ÙŠ Ø­Ù‚ÙŠÙ‚ÙŠØ©** ÙÙŠ 6 Ù…Ø­Ø§ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙˆØªØ­Ø¯ÙŠØ¯:
- âœ… Ù…Ø§ Ù‡Ùˆ Ø¬Ø§Ù‡Ø² ÙØ¹Ù„Ø§Ù‹
- âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ
- ğŸ”´ Ù…Ø§ ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ°Ù‡ Ù‚Ø¨Ù„ Ø£ÙŠ Ø¥Ø·Ù„Ø§Ù‚

---

## ğŸ“Š Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…

### Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©

| Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Ø§Ù„Ø±Ù…Ø² | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ |
|----------|------|-------|---------|
| **P0** | ğŸ”´ | **Ù…Ø§Ù†Ø¹ Ø¥Ø·Ù„Ø§Ù‚** | ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ°Ù‡ Ù‚Ø¨Ù„ Ø£ÙŠ Ø¥Ø·Ù„Ø§Ù‚ |
| **P1** | ğŸŸ  | **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹** | ÙŠÙ†ÙØ° Ø®Ù„Ø§Ù„ Ø£ÙˆÙ„ Ø´Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ |
| **P2** | ğŸŸ¡ | **ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†Ù…Ùˆ** | ÙŠÙ†ÙØ° Ø®Ù„Ø§Ù„ 3-6 Ø£Ø´Ù‡Ø± |

### Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø³ØªØ©

1. ğŸ§± **Correctness & Data Integrity** - ØµØ­Ø© Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø¯ÙØ¹
2. ğŸ’³ **Payments & Webhooks** - Stripe ÙƒÙ…ØµØ¯Ø± Ø­Ù‚ÙŠÙ‚Ø©
3. ğŸ“± **Mobile API Contract** - Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
4. âš¡ **Performance & Scalability** - ØªØ­Ù…Ù‘Ù„ Ø§Ù„Ø¶ØºØ·
5. ğŸ›¡ï¸ **Security & Observability** - Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
6. ğŸ—ï¸ **Ops & Go-Live** - Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ

---

## (1) ğŸ§± Correctness & Data Integrity

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **State Machine Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª** âœ…
   - Ù…Ù„Ù: `server/services/booking-state-machine.service.ts`
   - Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: 13 Ø­Ø§Ù„Ø©
   ```typescript
   "initiated" | "pending" | "reserved" | "paid" | "confirmed" | 
   "checked_in" | "boarded" | "completed" | "cancelled" | 
   "refunded" | "expired" | "payment_failed" | "no_show"
   ```
   - Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ `VALID_TRANSITIONS`
   - ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ `bookingStatusHistory`

2. **Idempotency Ù„Ù„Ø¯ÙØ¹** âœ… (Ø¬Ø²Ø¦ÙŠ)
   - Ù…Ù„Ù: `server/services/payments.service.ts`
   - ÙŠØ¯Ø¹Ù… `idempotencyKey` ÙÙŠ `createCheckoutSession`
   - ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ session Ø¬Ø¯ÙŠØ¯
   - Ù…Ø®Ø²Ù† ÙÙŠ Ø¬Ø¯ÙˆÙ„ `payments`

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Idempotency Ù„Ù„Ø­Ø¬Ø²** âŒ
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ `idempotencyKey` ÙÙŠ `createBooking`
   - Ø®Ø·Ø±: double booking Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨

2. **Transaction Wrapping** âš ï¸ (ØºÙŠØ± Ù…Ø¤ÙƒØ¯)
   - ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø© ÙÙŠ transactions
   - Ù…Ø«Ø§Ù„: Create booking + Reserve seats + Create payment

3. **Invariants Enforcement** âš ï¸
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ validation ØµØ±ÙŠØ­: "Ù„Ø§ Confirm Ø¨Ø¯ÙˆÙ† Payment ØµØ­ÙŠØ­"
   - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ application logic ÙÙ‚Ø·

4. **Integration Tests** âŒ
   - Ù„Ø§ ØªÙˆØ¬Ø¯ tests Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©:
     - Search â†’ Book â†’ Pay â†’ Confirm
     - Cancel â†’ Refund

### ğŸ”´ Ø§Ù„ØªØµÙ†ÙŠÙ: **P0 â€“ Ù…Ø§Ù†Ø¹ Ø¥Ø·Ù„Ø§Ù‚**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 1.1: Ø¥Ø¶Ø§ÙØ© Idempotency Ù„Ù„Ø­Ø¬Ø²
```typescript
// ÙÙŠ server/services/bookings.service.ts

export interface CreateBookingInput {
  idempotencyKey: string; // Ù…Ø·Ù„ÙˆØ¨
  flightId: number;
  passengers: PassengerInput[];
  // ...
}

export async function createBooking(input: CreateBookingInput) {
  // 1. Check idempotency
  const existing = await getBookingByIdempotencyKey(input.idempotencyKey);
  if (existing) {
    return existing; // Return cached result
  }

  // 2. Create booking in transaction
  return await db.transaction(async (tx) => {
    // ... booking logic
  });
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `drizzle/schema.ts` - Ø¥Ø¶Ø§ÙØ© `idempotencyKey` Ù„Ø¬Ø¯ÙˆÙ„ `bookings`
- `server/services/bookings.service.ts` - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ logic
- `server/db.ts` - Ø¥Ø¶Ø§ÙØ© `getBookingByIdempotencyKey`

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

#### Task 1.2: Ù„Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø© Ø¨Ù€ Transactions

```typescript
// Ù…Ø«Ø§Ù„: Create booking
export async function createBooking(input: CreateBookingInput) {
  return await db.transaction(async (tx) => {
    // 1. Check seat availability (with lock)
    const flight = await tx
      .select()
      .from(flights)
      .where(eq(flights.id, input.flightId))
      .for('update'); // Row-level lock

    // 2. Create booking
    const booking = await tx.insert(bookings).values({...});

    // 3. Reserve seats
    await tx.update(flights).set({
      availableSeats: sql`${flights.availableSeats} - ${input.passengers.length}`
    });

    // 4. Create passengers
    await tx.insert(passengers).values(...);

    return booking;
  });
}
```

**Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ transactions:**
- âœ… Create booking + Reserve seats + Create passengers
- âœ… Cancel booking + Release seats + Create refund
- âœ… Modify booking + Update seats + Create payment/refund
- âœ… Process payment + Update booking status

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `server/services/bookings.service.ts`
- `server/services/payments.service.ts`
- `server/services/refunds.service.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 8-12 Ø³Ø§Ø¹Ø§Øª

---

#### Task 1.3: Ø¥Ø¶Ø§ÙØ© Integration Tests

```typescript
// server/tests/integration/booking-flow.test.ts

describe('Booking Flow', () => {
  it('should complete full booking flow', async () => {
    // 1. Search flights
    const flights = await api.flights.search.query({...});
    
    // 2. Create booking
    const booking = await api.bookings.create.mutate({
      idempotencyKey: uuidv4(),
      ...
    });
    
    // 3. Process payment
    const payment = await api.payments.create.mutate({...});
    
    // 4. Verify booking confirmed
    expect(booking.status).toBe('confirmed');
    
    // 5. Verify seats updated
    const updatedFlight = await api.flights.get.query({...});
    expect(updatedFlight.availableSeats).toBe(originalSeats - 1);
  });

  it('should prevent double booking', async () => {
    // Test idempotency
  });

  it('should handle payment failure correctly', async () => {
    // Test rollback
  });
});
```

**Test Cases Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- âœ… Happy path: Search â†’ Book â†’ Pay â†’ Confirm
- âœ… Idempotency: Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨
- âœ… Double booking prevention
- âœ… Payment failure handling
- âœ… Cancellation and refund
- âœ… Seat availability updates

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/tests/integration/booking-flow.test.ts`
- `server/tests/integration/payment-flow.test.ts`
- `server/tests/integration/cancellation-flow.test.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 12-16 Ø³Ø§Ø¹Ø§Øª

---

## (2) ğŸ’³ Payments & Stripe Webhooks

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **Stripe Integration** âœ…
   - Ù…Ù„Ù: `server/services/payments.service.ts`
   - Checkout session creation
   - Payment success handling

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Webhook Handler** âŒ
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ endpoint Ù„Ù€ Stripe webhooks
   - Ù„Ø§ signature verification
   - Ù„Ø§ event de-duplication

2. **Event Storage** âŒ
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ `stripe_events`
   - Ø®Ø·Ø±: Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙØ³ Ø§Ù„Ù€ event Ù…Ø±ØªÙŠÙ†

3. **Financial Ledger** âŒ
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ audit trail Ù…Ø§Ù„ÙŠ ÙˆØ§Ø¶Ø­
   - ØµØ¹ÙˆØ¨Ø© ÙÙŠ reconciliation

4. **Reconciliation Job** âŒ
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ job Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Stripe Ù…Ø¹ DB

### ğŸ”´ Ø§Ù„ØªØµÙ†ÙŠÙ: **P0 â€“ Ù…Ø§Ù†Ø¹ Ø¥Ø·Ù„Ø§Ù‚**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 2.1: Ø¥Ù†Ø´Ø§Ø¡ Webhook Handler

```typescript
// server/routers/webhooks.ts

import { router, publicProcedure } from "../_core/trpc";
import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export const webhooksRouter = router({
  stripe: publicProcedure
    .input(z.object({
      body: z.string(),
      signature: z.string(),
    }))
    .mutation(async ({ input }) => {
      // 1. Verify signature
      let event: Stripe.Event;
      try {
        event = stripe.webhooks.constructEvent(
          input.body,
          input.signature,
          process.env.STRIPE_WEBHOOK_SECRET!
        );
      } catch (err) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Invalid signature",
        });
      }

      // 2. Check for duplicate
      const existing = await getStripeEventById(event.id);
      if (existing) {
        return { received: true, duplicate: true };
      }

      // 3. Store event
      await storeStripeEvent(event);

      // 4. Process event
      await processStripeEvent(event);

      return { received: true };
    }),
});
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/routers/webhooks.ts`
- `server/services/stripe-webhook.service.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 6-8 Ø³Ø§Ø¹Ø§Øª

---

#### Task 2.2: Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Stripe Events

```typescript
// drizzle/schema.ts

export const stripeEvents = pgTable('stripe_events', {
  id: varchar('id', { length: 255 }).primaryKey(), // Stripe event ID
  type: varchar('type', { length: 100 }).notNull(),
  data: json('data').notNull(),
  processed: boolean('processed').default(false).notNull(),
  processedAt: timestamp('processed_at'),
  error: text('error'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  typeIdx: index('stripe_events_type_idx').on(table.type),
  processedIdx: index('stripe_events_processed_idx').on(table.processed),
}));
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `drizzle/schema.ts`
- Migration file

**Ø§Ù„Ø¬Ù‡Ø¯:** 2-3 Ø³Ø§Ø¹Ø§Øª

---

#### Task 2.3: Ø¥Ù†Ø´Ø§Ø¡ Financial Ledger

```typescript
// drizzle/schema.ts

export const financialLedger = pgTable('financial_ledger', {
  id: serial('id').primaryKey(),
  bookingId: integer('booking_id').references(() => bookings.id),
  type: varchar('type', { length: 50 }).notNull(), // 'charge', 'refund', 'fee'
  amount: decimal('amount', { precision: 10, scale: 2 }).notNull(),
  currency: varchar('currency', { length: 3 }).notNull(),
  stripeEventId: varchar('stripe_event_id', { length: 255 }),
  stripePaymentIntentId: varchar('stripe_payment_intent_id', { length: 255 }),
  description: text('description'),
  metadata: json('metadata'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  bookingIdIdx: index('financial_ledger_booking_id_idx').on(table.bookingId),
  typeIdx: index('financial_ledger_type_idx').on(table.type),
}));
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `drizzle/schema.ts`
- `server/services/ledger.service.ts` (Ø¬Ø¯ÙŠØ¯)

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

#### Task 2.4: Ø¥Ù†Ø´Ø§Ø¡ Reconciliation Job

```typescript
// server/jobs/reconciliation.job.ts

export async function reconcilePayments() {
  // 1. Get all bookings with 'paid' status from last 7 days
  const bookings = await getRecentPaidBookings(7);

  for (const booking of bookings) {
    // 2. Get payment from Stripe
    const stripePayment = await stripe.paymentIntents.retrieve(
      booking.paymentIntentId
    );

    // 3. Compare with our DB
    if (stripePayment.status !== 'succeeded' && booking.status === 'confirmed') {
      // Mismatch! Alert and log
      logger.error('Payment mismatch detected', {
        bookingId: booking.id,
        ourStatus: booking.status,
        stripeStatus: stripePayment.status,
      });

      // Send alert
      await sendAlert({
        type: 'payment_mismatch',
        bookingId: booking.id,
      });
    }
  }
}

// Run daily at 2 AM
schedule.scheduleJob('0 2 * * *', reconcilePayments);
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/jobs/reconciliation.job.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

## (3) ğŸ“± Mobile API Contract

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **tRPC API** âœ…
   - Type-safe APIs
   - Auto-generated types

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Mobile Auth Strategy** âŒ
   - Ø­Ø§Ù„ÙŠØ§Ù‹: Cookie-based (Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¬ÙŠØ¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
   - Ù…Ø·Ù„ÙˆØ¨: Bearer + Refresh Token

2. **Error Contract** âš ï¸
   - Errors ØºÙŠØ± Ù…ÙˆØ­Ø¯Ø©
   - Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ø§ ÙŠØ¹Ø±Ù ÙƒÙŠÙ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§

3. **API Documentation** âš ï¸
   - Ù„Ø§ ÙŠÙˆØ¬Ø¯ documentation Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
   - Ù„Ø§ Postman collection

### ğŸ”´ Ø§Ù„ØªØµÙ†ÙŠÙ: **P0 â€“ Ù…Ø§Ù†Ø¹ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 3.1: ØªØ·Ø¨ÙŠÙ‚ Bearer Token Auth

```typescript
// server/_core/auth.ts

export async function authenticateRequest(req: Request) {
  // Support both Cookie and Bearer
  const token = 
    req.cookies.get('auth_token') || 
    req.headers.get('Authorization')?.replace('Bearer ', '');

  if (!token) {
    throw new TRPCError({ code: 'UNAUTHORIZED' });
  }

  const payload = verifyJWT(token);
  return payload;
}

// New endpoint for mobile login
export async function mobileLogin(email: string, password: string) {
  const user = await authenticateUser(email, password);

  const accessToken = generateJWT(user, '15m');
  const refreshToken = generateJWT(user, '7d');

  // Store refresh token
  await storeRefreshToken(user.id, refreshToken);

  return {
    accessToken,
    refreshToken,
    expiresIn: 900, // 15 minutes
  };
}

// Refresh token endpoint
export async function refreshAccessToken(refreshToken: string) {
  const payload = verifyJWT(refreshToken);
  
  // Verify refresh token is valid
  const isValid = await verifyRefreshToken(payload.userId, refreshToken);
  if (!isValid) {
    throw new TRPCError({ code: 'UNAUTHORIZED' });
  }

  const newAccessToken = generateJWT(payload, '15m');
  
  return {
    accessToken: newAccessToken,
    expiresIn: 900,
  };
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `server/_core/auth.ts`
- `server/routers/auth.ts`
- `drizzle/schema.ts` - Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ `refresh_tokens`

**Ø§Ù„Ø¬Ù‡Ø¯:** 6-8 Ø³Ø§Ø¹Ø§Øª

---

#### Task 3.2: ØªÙˆØ­ÙŠØ¯ Error Contract

```typescript
// server/_core/errors.ts

export interface APIError {
  code: string; // Machine-readable code
  message: string; // Human-readable message
  correlationId: string; // For tracking
  retryable: boolean; // Can the client retry?
  details?: any; // Additional context
}

// Error codes
export const ErrorCodes = {
  // Booking errors
  BOOKING_CONFLICT: 'BOOKING_CONFLICT',
  SEATS_UNAVAILABLE: 'SEATS_UNAVAILABLE',
  BOOKING_EXPIRED: 'BOOKING_EXPIRED',
  
  // Payment errors
  PAYMENT_FAILED: 'PAYMENT_FAILED',
  PAYMENT_REQUIRED: 'PAYMENT_REQUIRED',
  
  // Auth errors
  UNAUTHORIZED: 'UNAUTHORIZED',
  TOKEN_EXPIRED: 'TOKEN_EXPIRED',
  
  // Generic errors
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
};

// Error transformer
export function transformError(error: any, correlationId: string): APIError {
  if (error instanceof TRPCError) {
    return {
      code: mapTRPCCodeToAPICode(error.code),
      message: error.message,
      correlationId,
      retryable: isRetryable(error.code),
      details: error.cause,
    };
  }

  // Default error
  return {
    code: ErrorCodes.INTERNAL_ERROR,
    message: 'An unexpected error occurred',
    correlationId,
    retryable: false,
  };
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/_core/errors.ts`

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `server/_core/trpc.ts` - Ø¥Ø¶Ø§ÙØ© error transformer

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

#### Task 3.3: Ø¥Ù†Ø´Ø§Ø¡ Mobile API Documentation

```markdown
# AIS Mobile API Documentation

## Authentication

### Login
POST /api/auth/mobile-login

Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "accessToken": "eyJ...",
  "refreshToken": "eyJ...",
  "expiresIn": 900
}

### Refresh Token
POST /api/auth/refresh

Headers:
Authorization: Bearer <refreshToken>

Response:
{
  "accessToken": "eyJ...",
  "expiresIn": 900
}

## Flights

### Search Flights
POST /api/flights/search

Headers:
Authorization: Bearer <accessToken>

Request:
{
  "from": "RUH",
  "to": "JED",
  "date": "2026-02-01",
  "passengers": 1
}

Response:
{
  "flights": [
    {
      "id": 1,
      "flightNumber": "SV123",
      "from": "RUH",
      "to": "JED",
      "departureTime": "2026-02-01T10:00:00Z",
      "arrivalTime": "2026-02-01T11:30:00Z",
      "price": 500,
      "currency": "SAR",
      "availableSeats": 50
    }
  ]
}

## Error Handling

All errors follow this format:

{
  "code": "SEATS_UNAVAILABLE",
  "message": "No seats available for this flight",
  "correlationId": "abc-123",
  "retryable": false,
  "details": {}
}

Error Codes:
- BOOKING_CONFLICT: Another booking is in progress
- SEATS_UNAVAILABLE: No seats available
- PAYMENT_FAILED: Payment processing failed
- UNAUTHORIZED: Invalid or expired token
- TOKEN_EXPIRED: Access token expired, use refresh token
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `docs/MOBILE_API_DOCUMENTATION.md`
- `postman/AIS_Mobile_API.postman_collection.json`

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

## (4) âš¡ Performance & Scalability

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **Database Indexing** âœ…
   - Indexes Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Redis Caching** âŒ
   - Ù„Ø§ caching Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
   - Ù„Ø§ caching Ù„Ù„Ù€ rate limits

2. **Background Queue** âŒ
   - Emails ØªØ±Ø³Ù„ synchronously
   - Webhook retries ØªØ­Ø¯Ø« ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù€ request

3. **Response Compression** âš ï¸
   - ØºÙŠØ± Ù…ØªØ£ÙƒØ¯ Ø¥Ø°Ø§ Ù…ÙØ¹Ù‘Ù„

### ğŸŸ  Ø§Ù„ØªØµÙ†ÙŠÙ: **P1 â€“ Ù„Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ØŒ Ù„ÙƒÙ† Ø®Ø·Ø± Ù…Ø¹ Ø§Ù„Ø¶ØºØ·**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 4.1: Ø¥Ø¶Ø§ÙØ© Redis

```typescript
// server/_core/redis.ts

import { createClient } from 'redis';

export const redis = createClient({
  url: process.env.REDIS_URL || 'redis://localhost:6379',
});

await redis.connect();

// Cache service
export class CacheService {
  async get<T>(key: string): Promise<T | null> {
    const value = await redis.get(key);
    return value ? JSON.parse(value) : null;
  }

  async set(key: string, value: any, ttl: number = 300) {
    await redis.setEx(key, ttl, JSON.stringify(value));
  }

  async del(key: string) {
    await redis.del(key);
  }
}

// Usage: Cache search results
export async function searchFlights(params: SearchParams) {
  const cacheKey = `flights:${JSON.stringify(params)}`;
  
  // Check cache
  const cached = await cache.get(cacheKey);
  if (cached) {
    return cached;
  }

  // Query DB
  const flights = await db.searchFlights(params);

  // Store in cache (5 minutes)
  await cache.set(cacheKey, flights, 300);

  return flights;
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/_core/redis.ts`
- `server/services/cache.service.ts`

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `server/services/flights.service.ts`
- `docker-compose.production.yml` - Ø¥Ø¶Ø§ÙØ© Redis

**Ø§Ù„Ø¬Ù‡Ø¯:** 6-8 Ø³Ø§Ø¹Ø§Øª

---

#### Task 4.2: Ø¥Ø¶Ø§ÙØ© Background Queue (BullMQ)

```typescript
// server/services/queue.service.ts

import { Queue, Worker } from 'bullmq';

// Email queue
export const emailQueue = new Queue('emails', {
  connection: redis,
});

// Worker
const emailWorker = new Worker('emails', async (job) => {
  const { to, subject, body } = job.data;
  await sendEmail(to, subject, body);
}, {
  connection: redis,
});

// Usage
export async function sendBookingConfirmationEmail(booking: Booking) {
  await emailQueue.add('booking-confirmation', {
    to: booking.user.email,
    subject: 'Booking Confirmed',
    body: generateEmailBody(booking),
  });
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/services/queue.service.ts`
- `server/jobs/email.job.ts`
- `server/jobs/webhook-retry.job.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 8-10 Ø³Ø§Ø¹Ø§Øª

---

## (5) ğŸ›¡ï¸ Security & Observability

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **Helmet** âœ…
2. **Rate Limiting** âœ…
3. **CSRF Protection** âœ…

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Correlation ID** âŒ
   - Ù„Ø§ correlation ID ÙÙŠ requests
   - ØµØ¹ÙˆØ¨Ø© ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

2. **Error Tracking** âš ï¸
   - Ù„Ø§ Sentry Ø£Ùˆ Ù…Ø´Ø§Ø¨Ù‡

3. **Audit Logs** âŒ
   - Ù„Ø§ audit trail Ù„Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø­Ø³Ø§Ø³Ø©

### ğŸŸ  Ø§Ù„ØªØµÙ†ÙŠÙ: **P1**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 5.1: Ø¥Ø¶Ø§ÙØ© Correlation ID

```typescript
// server/_core/middleware.ts

import { v4 as uuidv4 } from 'uuid';

export function correlationIdMiddleware(req: Request, res: Response, next: NextFunction) {
  const correlationId = req.headers.get('x-correlation-id') || uuidv4();
  
  // Attach to request
  req.correlationId = correlationId;
  
  // Add to response headers
  res.setHeader('x-correlation-id', correlationId);
  
  next();
}

// Logger
export function log(message: string, data?: any) {
  logger.info(message, {
    correlationId: getCurrentCorrelationId(),
    ...data,
  });
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/_core/correlation.ts`

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `server/_core/middleware.ts`
- `server/_core/logger.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 3-4 Ø³Ø§Ø¹Ø§Øª

---

#### Task 5.2: Ø¥Ø¶Ø§ÙØ© Sentry

```typescript
// server/_core/sentry.ts

import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});

// Error handler
export function captureError(error: Error, context?: any) {
  Sentry.captureException(error, {
    extra: context,
  });
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `server/_core/sentry.ts`

**Ø§Ù„Ø¬Ù‡Ø¯:** 2-3 Ø³Ø§Ø¹Ø§Øª

---

#### Task 5.3: Ø¥Ø¶Ø§ÙØ© Audit Logs

```typescript
// drizzle/schema.ts

export const auditLogs = pgTable('audit_logs', {
  id: serial('id').primaryKey(),
  userId: integer('user_id'),
  action: varchar('action', { length: 100 }).notNull(),
  resourceType: varchar('resource_type', { length: 50 }).notNull(),
  resourceId: varchar('resource_id', { length: 255 }).notNull(),
  changes: json('changes'),
  ipAddress: varchar('ip_address', { length: 45 }),
  userAgent: text('user_agent'),
  correlationId: varchar('correlation_id', { length: 255 }),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  userIdIdx: index('audit_logs_user_id_idx').on(table.userId),
  actionIdx: index('audit_logs_action_idx').on(table.action),
}));

// Usage
export async function logAudit(data: AuditLogData) {
  await db.insert(auditLogs).values({
    userId: data.userId,
    action: data.action, // 'refund', 'cancel', 'admin_override'
    resourceType: data.resourceType, // 'booking', 'payment'
    resourceId: data.resourceId,
    changes: data.changes,
    ipAddress: data.ipAddress,
    userAgent: data.userAgent,
    correlationId: data.correlationId,
  });
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- `drizzle/schema.ts`
- `server/services/audit.service.ts` (Ø¬Ø¯ÙŠØ¯)

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

## (6) ğŸ—ï¸ Ops & Go-Live

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ

#### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯

1. **Docker Setup** âœ…
2. **Environment Variables** âœ…

#### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ

1. **Backup/Restore Testing** âŒ
   - Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªØ¨Ø§Ø± restore Ù…Ù† backup

2. **Load Testing** âŒ
   - Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ­Øª Ø§Ù„Ø¶ØºØ·

3. **Runbook** âš ï¸
   - Ù„Ø§ runbook Ù„Ù„Ø­ÙˆØ§Ø¯Ø«

4. **Production Topology** âœ…
   - Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ `docker-compose.production.yml`

### ğŸŸ /ğŸŸ¡ Ø§Ù„ØªØµÙ†ÙŠÙ: **P1/P2**

### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

#### Task 6.1: Ø§Ø®ØªØ¨Ø§Ø± Backup/Restore

```bash
# 1. Create backup
./scripts/backup.sh

# 2. Test restore
./scripts/restore.sh backups/ais_db_20260126.sql.gz

# 3. Verify data integrity
psql $DATABASE_URL -c "SELECT COUNT(*) FROM bookings;"
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `scripts/backup.sh` âœ… (Ù…ÙˆØ¬ÙˆØ¯)
- `scripts/restore.sh` (Ø¬Ø¯ÙŠØ¯)
- `scripts/verify-backup.sh` (Ø¬Ø¯ÙŠØ¯)

**Ø§Ù„Ø¬Ù‡Ø¯:** 2-3 Ø³Ø§Ø¹Ø§Øª

---

#### Task 6.2: Load Testing

```javascript
// tests/load/booking-flow.js

import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 50 }, // Ramp up to 50 users
    { duration: '5m', target: 50 }, // Stay at 50 users
    { duration: '2m', target: 100 }, // Ramp up to 100 users
    { duration: '5m', target: 100 }, // Stay at 100 users
    { duration: '2m', target: 0 }, // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% of requests must complete below 500ms
    http_req_failed: ['rate<0.01'], // Error rate must be below 1%
  },
};

export default function () {
  // 1. Search flights
  const searchRes = http.post('https://api.ais.example.com/flights/search', {
    from: 'RUH',
    to: 'JED',
    date: '2026-02-01',
  });

  check(searchRes, {
    'search status is 200': (r) => r.status === 200,
    'search response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);

  // 2. Create booking
  const bookingRes = http.post('https://api.ais.example.com/bookings', {
    idempotencyKey: `test-${Date.now()}`,
    flightId: 1,
    passengers: [{ firstName: 'Test', lastName: 'User' }],
  });

  check(bookingRes, {
    'booking status is 200': (r) => r.status === 200,
  });

  sleep(2);
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `tests/load/booking-flow.js`
- `tests/load/search-only.js`

**Ø§Ù„Ø¬Ù‡Ø¯:** 4-6 Ø³Ø§Ø¹Ø§Øª

---

#### Task 6.3: Ø¥Ù†Ø´Ø§Ø¡ Incident Runbook

```markdown
# Incident Runbook

## Stripe Down

### Symptoms
- Payment creation fails
- Webhooks not received

### Actions
1. Check Stripe status: https://status.stripe.com
2. Enable "maintenance mode" in app
3. Queue payment requests for retry
4. Notify users via email/SMS

## Database Slow

### Symptoms
- Response times > 2s
- High CPU on DB server

### Actions
1. Check slow query log
2. Check connection pool usage
3. Consider adding indexes
4. Scale DB vertically if needed

## High Error Rate

### Symptoms
- Error rate > 5%
- Sentry alerts

### Actions
1. Check Sentry for error details
2. Check correlation IDs in logs
3. Rollback if recent deployment
4. Scale horizontally if load issue
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:**
- `docs/INCIDENT_RUNBOOK.md`

**Ø§Ù„Ø¬Ù‡Ø¯:** 2-3 Ø³Ø§Ø¹Ø§Øª

---

## ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…

### Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

| Ø§Ù„Ù…Ø­ÙˆØ± | Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„Ø¯Ø±Ø¬Ø© | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© |
|--------|--------|--------|----------|
| Correctness & Data Integrity | âš ï¸ Ø¬Ø²Ø¦ÙŠ | 70% | ğŸ”´ P0 |
| Payments & Webhooks | âŒ Ù†Ø§Ù‚Øµ | 40% | ğŸ”´ P0 |
| Mobile API Contract | âŒ Ù†Ø§Ù‚Øµ | 30% | ğŸ”´ P0 |
| Performance & Scalability | âŒ Ù†Ø§Ù‚Øµ | 50% | ğŸŸ  P1 |
| Security & Observability | âš ï¸ Ø¬Ø²Ø¦ÙŠ | 60% | ğŸŸ  P1 |
| Ops & Go-Live | âš ï¸ Ø¬Ø²Ø¦ÙŠ | 65% | ğŸŸ¡ P2 |

**Overall Readiness:** **52%** ğŸŸ 

---

## ğŸš¨ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„ØµØ±ÙŠØ­

### âŒ Ù„Ø§ ØªØ·Ù„Ù‚ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° (P0):

1. âœ… Idempotency Ù„Ù„Ø­Ø¬Ø²
2. âœ… Transaction wrapping Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
3. âœ… Integration tests
4. âœ… Stripe webhook handler
5. âœ… Event de-duplication
6. âœ… Financial ledger
7. âœ… Mobile auth (Bearer + Refresh)
8. âœ… Error contract Ù…ÙˆØ­Ø¯

**Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:** **60-80 Ø³Ø§Ø¹Ø©** (1.5-2 Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„)

### ğŸŸ  Ù†ÙÙ‘Ø° Ø®Ù„Ø§Ù„ Ø£ÙˆÙ„ Ø´Ù‡Ø± (P1):

1. Redis caching
2. Background queue (BullMQ)
3. Correlation ID
4. Sentry
5. Audit logs
6. Reconciliation job

**Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:** **30-40 Ø³Ø§Ø¹Ø©** (1 Ø£Ø³Ø¨ÙˆØ¹)

### ğŸŸ¡ Ù†ÙÙ‘Ø° Ø®Ù„Ø§Ù„ 3-6 Ø£Ø´Ù‡Ø± (P2):

1. Backup/restore testing
2. Load testing
3. Incident runbook

**Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:** **10-15 Ø³Ø§Ø¹Ø©**

---

## ğŸ“‹ Ø®Ø·Ø© ØªÙ†ÙÙŠØ° Ù…Ø®ØªØµØ±Ø© (4 Ø£Ø³Ø§Ø¨ÙŠØ¹)

### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1-2: Core Correctness (P0)
- [ ] Idempotency Ù„Ù„Ø­Ø¬Ø² (6h)
- [ ] Transaction wrapping (12h)
- [ ] Integration tests (16h)
- [ ] Stripe webhook handler (8h)
- [ ] Event de-duplication (3h)
- [ ] Financial ledger (6h)

**Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:** 51 Ø³Ø§Ø¹Ø©

### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3: Mobile & Observability (P0 + P1)
- [ ] Mobile auth (8h)
- [ ] Error contract (6h)
- [ ] API documentation (6h)
- [ ] Correlation ID (4h)
- [ ] Sentry (3h)

**Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:** 27 Ø³Ø§Ø¹Ø©

### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4: Performance & Ops (P1)
- [ ] Redis setup (8h)
- [ ] Background queue (10h)
- [ ] Audit logs (6h)
- [ ] Reconciliation job (6h)
- [ ] Backup/restore test (3h)

**Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:** 33 Ø³Ø§Ø¹Ø©

---

## âœ… Acceptance Criteria

### Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚ Beta

- [x] Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… P0 Ù…ÙƒØªÙ…Ù„Ø©
- [x] Integration tests ØªÙ…Ø± Ø¨Ù†Ø¬Ø§Ø­
- [x] Stripe webhooks ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- [x] Mobile app ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API
- [x] Ù„Ø§ double booking ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ­Ø¯Ø«
- [x] Ù„Ø§ double charge ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ­Ø¯Ø«

### Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„

- [x] Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… P0 + P1 Ù…ÙƒØªÙ…Ù„Ø©
- [x] Redis caching ÙŠØ¹Ù…Ù„
- [x] Background jobs ØªØ¹Ù…Ù„
- [x] Observability ÙƒØ§Ù…Ù„Ø©
- [x] Load test ÙŠÙ…Ø± Ø¨Ù†Ø¬Ø§Ø­

---

**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 26 ÙŠÙ†Ø§ÙŠØ± 2026
