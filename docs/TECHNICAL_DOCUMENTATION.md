# التوثيق التقني الكامل - نظام AIS للطيران

**الإصدار:** 2.0.0  
**التاريخ:** 26 يناير 2026  
**المراجع:** Manus AI Copilot

---

## جدول المحتويات

1. [نظرة عامة على النظام](#1-نظرة-عامة-على-النظام)
2. [البنية المعمارية](#2-البنية-المعمارية)
3. [قاعدة البيانات](#3-قاعدة-البيانات)
4. [الواجهات البرمجية (APIs)](#4-الواجهات-البرمجية-apis)
5. [الواجهة الأمامية](#5-الواجهة-الأمامية)
6. [الأمان](#6-الأمان)
7. [الاختبارات](#7-الاختبارات)
8. [النشر والتشغيل](#8-النشر-والتشغيل)

---

## 1. نظرة عامة على النظام

### 1.1 الوصف

نظام الطيران المتكامل (AIS - Aviation Information System) هو منصة شاملة لحجز تذاكر الطيران وإدارة الرحلات. يوفر النظام واجهة سهلة الاستخدام للركاب لحجز الرحلات، ولوحة تحكم قوية للإداريين لإدارة العمليات.

### 1.2 الميزات الرئيسية

| الميزة                  | الوصف                                              |
| ----------------------- | -------------------------------------------------- |
| **البحث عن الرحلات**    | بحث متقدم بفلاتر متعددة (الوجهة، التاريخ، الفئة)   |
| **الحجز الإلكتروني**    | نظام حجز كامل مع دعم عدة ركاب                      |
| **الدفع الآمن**         | تكامل مع Stripe لمعالجة المدفوعات                  |
| **التذاكر الإلكترونية** | توليد تذاكر PDF مع رموز QR                         |
| **برنامج الولاء**       | نظام نقاط مع مستويات عضوية (Bronze, Silver, Gold)  |
| **تعديل الحجوزات**      | إمكانية تعديل التاريخ أو ترقية الفئة               |
| **إلغاء واسترجاع**      | نظام إلغاء مع حساب رسوم الإلغاء واسترجاع المدفوعات |
| **لوحة التحكم**         | لوحة تحكم شاملة للإداريين مع تحليلات وإحصائيات     |

### 1.3 الإحصائيات

- **عدد ملفات TypeScript:** 213 ملف
- **إجمالي الأسطر البرمجية:** 34,734 سطر
- **عدد الاختبارات:** 26 اختبار آلي
- **عدد الجداول في قاعدة البيانات:** 20 جدول
- **عدد الخدمات (Services):** 24 خدمة
- **عدد الموجهات (Routers):** 15 موجه
- **عدد صفحات الواجهة:** 13 صفحة
- **عدد المكونات:** 72+ مكون

---

## 2. البنية المعمارية

### 2.1 نمط المعمارية

يتبع النظام **بنية ثلاثية الطبقات (Three-Tier Architecture)** مع فصل واضح بين:

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│  React 19 + TypeScript + Tailwind CSS + shadcn/ui          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ tRPC (Type-safe API)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                      │
│    Express + tRPC Routers + Services + Middleware           │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Drizzle ORM
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data Persistence Layer                    │
│              MySQL/TiDB + Redis (future cache)              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 التقنيات المستخدمة

#### الواجهة الأمامية (Frontend)

| التقنية        | الإصدار | الاستخدام             |
| -------------- | ------- | --------------------- |
| React          | 19.1.1  | مكتبة واجهة المستخدم  |
| TypeScript     | 5.9.3   | لغة البرمجة           |
| Tailwind CSS   | 4.1.14  | إطار عمل التصميم      |
| shadcn/ui      | -       | مكونات واجهة المستخدم |
| Wouter         | 3.3.5   | مكتبة التوجيه         |
| TanStack Query | 5.90.2  | إدارة حالة الخادم     |
| date-fns       | 4.1.0   | التعامل مع التواريخ   |
| Framer Motion  | 12.23   | الرسوم المتحركة       |

#### الواجهة الخلفية (Backend)

| التقنية            | الإصدار | الاستخدام               |
| ------------------ | ------- | ----------------------- |
| Express            | 4.21.2  | خادم الويب              |
| tRPC               | 11.6.0  | واجهات برمجية type-safe |
| Drizzle ORM        | 0.44.5  | ORM لقاعدة البيانات     |
| MySQL              | -       | قاعدة البيانات          |
| Stripe             | 20.0.0  | معالجة المدفوعات        |
| Helmet             | 8.1.0   | أمان رؤوس HTTP          |
| express-rate-limit | 8.2.1   | تقييد معدل الطلبات      |

#### الاختبارات والأدوات

| التقنية    | الإصدار | الاستخدام       |
| ---------- | ------- | --------------- |
| Vitest     | 2.1.4   | إطار الاختبار   |
| Playwright | -       | اختبارات E2E    |
| Vite       | 7.1.7   | أداة البناء     |
| ESBuild    | 0.25.0  | مجمع JavaScript |

### 2.3 الأنماط المعمارية المستخدمة

#### نمط الطبقات (Layered Pattern)

```
┌──────────────────────────────────────────┐
│         Controllers (tRPC Routers)        │  ← نقاط النهاية
├──────────────────────────────────────────┤
│         Services (Business Logic)         │  ← المنطق الأساسي
├──────────────────────────────────────────┤
│         Repositories (Data Access)        │  ← استعلامات قاعدة البيانات
├──────────────────────────────────────────┤
│         Models (Database Schema)          │  ← هياكل البيانات
└──────────────────────────────────────────┘
```

#### التصميم الموجه بالمجال (Domain-Driven Design)

الكود منظم حسب المجالات التجارية:

- **Flights Domain**: البحث عن الرحلات، الجدولة، الحالة
- **Bookings Domain**: الحجوزات، التعديلات، الإلغاءات
- **Payments Domain**: الدفع، الاستردادات، سجل المدفوعات
- **Loyalty Domain**: النقاط، المستويات، المكافآت
- **Admin Domain**: التحليلات، الإدارة، التقارير

---

## 3. قاعدة البيانات

### 3.1 الجداول الرئيسية

| الجدول                   | الوصف                       | عدد الحقول |
| ------------------------ | --------------------------- | ---------- |
| `users`                  | بيانات المستخدمين والمصادقة | 7          |
| `airlines`               | شركات الطيران               | 6          |
| `airports`               | المطارات                    | 7          |
| `flights`                | الرحلات الجوية              | 14         |
| `bookings`               | الحجوزات                    | 14         |
| `passengers`             | بيانات الركاب               | 11         |
| `payments`               | المدفوعات                   | 9          |
| `loyalty_accounts`       | حسابات برنامج الولاء        | 7          |
| `miles_transactions`     | معاملات النقاط              | 7          |
| `booking_modifications`  | تعديلات الحجوزات            | 10         |
| `inventory_locks`        | قفل المقاعد المؤقت          | 6          |
| `ancillary_services`     | الخدمات الإضافية            | 6          |
| `booking_ancillaries`    | ربط الحجوزات بالخدمات       | 5          |
| `flight_reviews`         | تقييمات الرحلات             | 8          |
| `favorite_flights`       | الرحلات المفضلة             | 4          |
| `user_preferences`       | تفضيلات المستخدم            | 6          |
| `audit_logs`             | سجلات التدقيق               | 7          |
| `flight_status_history`  | سجل تغييرات حالة الرحلات    | 7          |
| `booking_status_history` | سجل تغييرات حالة الحجوزات   | 7          |
| `price_alert_history`    | سجل تنبيهات الأسعار         | 7          |

### 3.2 الفهارس (Indexes)

تم إنشاء فهارس على الحقول التالية لتحسين الأداء:

- `flights`: `flightNumber`, `departureTime`, `originId + destinationId`, `airlineId`, `status`
- `bookings`: `userId`, `pnr`, `bookingReference`
- `passengers`: `bookingId`
- `payments`: `bookingId`, `idempotencyKey`

### 3.3 العلاقات

```
users (1) ──────── (N) bookings
bookings (1) ────── (N) passengers
bookings (1) ────── (N) payments
flights (1) ──────── (N) bookings
airlines (1) ─────── (N) flights
airports (1) ─────── (N) flights (origin)
airports (1) ─────── (N) flights (destination)
users (1) ────────── (1) loyalty_accounts
loyalty_accounts (1) ─ (N) miles_transactions
```

---

## 4. الواجهات البرمجية (APIs)

### 4.1 الموجهات (Routers)

| الموجه             | الوصف                      | عدد Endpoints |
| ------------------ | -------------------------- | ------------- |
| `flights`          | البحث عن الرحلات وتفاصيلها | 3             |
| `bookings`         | إدارة الحجوزات             | 5             |
| `payments`         | معالجة المدفوعات           | 3             |
| `eticket`          | توليد التذاكر الإلكترونية  | 2             |
| `loyalty`          | برنامج الولاء              | 4             |
| `modifications`    | تعديل الحجوزات             | 3             |
| `refunds`          | الاستردادات                | 4             |
| `favorites`        | الرحلات المفضلة            | 4             |
| `reviews`          | التقييمات                  | 4             |
| `ancillary`        | الخدمات الإضافية           | 3             |
| `user-preferences` | تفضيلات المستخدم           | 3             |
| `analytics`        | التحليلات والإحصائيات      | 6             |
| `admin`            | إدارة النظام               | 8             |
| `health`           | فحص صحة النظام             | 1             |
| `reference`        | البيانات المرجعية          | 2             |

### 4.2 المصادقة والتفويض

النظام يستخدم **Manus OAuth** للمصادقة مع ثلاثة مستويات من الوصول:

1. **Public**: لا يتطلب مصادقة (البحث عن الرحلات)
2. **Protected**: يتطلب مصادقة (إنشاء حجز)
3. **Admin**: يتطلب دور إداري (إدارة الرحلات)

---

## 5. الواجهة الأمامية

### 5.1 الصفحات الرئيسية

| الصفحة             | المسار               | الوصف                  |
| ------------------ | -------------------- | ---------------------- |
| Home               | `/`                  | الصفحة الرئيسية والبحث |
| SearchResults      | `/search`            | نتائج البحث عن الرحلات |
| BookingPage        | `/booking/:flightId` | صفحة الحجز             |
| MyBookings         | `/my-bookings`       | حجوزاتي                |
| CheckIn            | `/checkin`           | تسجيل الوصول           |
| LoyaltyDashboard   | `/loyalty`           | لوحة برنامج الولاء     |
| UserProfile        | `/profile`           | الملف الشخصي           |
| AdminDashboard     | `/admin`             | لوحة التحكم الإدارية   |
| AnalyticsDashboard | `/admin/analytics`   | لوحة التحليلات         |
| RefundsDashboard   | `/admin/refunds`     | لوحة الاستردادات       |

### 5.2 المكونات الرئيسية

- **FlightCard**: عرض معلومات الرحلة
- **BookingCard**: عرض معلومات الحجز
- **PassengerForm**: نموذج إدخال بيانات الركاب
- **SeatMap**: خريطة المقاعد التفاعلية
- **PaymentForm**: نموذج الدفع
- **LoyaltyCard**: عرض معلومات برنامج الولاء
- **AnalyticsChart**: الرسوم البيانية للتحليلات

---

## 6. الأمان

### 6.1 آليات الحماية

| الآلية               | الوصف                           |
| -------------------- | ------------------------------- |
| **Helmet**           | تأمين رؤوس HTTP                 |
| **CSRF Protection**  | الحماية من هجمات CSRF           |
| **Rate Limiting**    | تقييد معدل الطلبات              |
| **Input Validation** | التحقق من المدخلات باستخدام Zod |
| **SQL Injection**    | الحماية عبر Drizzle ORM         |
| **XSS Protection**   | تنقية المدخلات                  |
| **HTTPS Only**       | فرض استخدام HTTPS في الإنتاج    |

### 6.2 المصادقة

- **JWT Tokens**: مخزنة في httpOnly Cookies
- **Token Expiry**: 7 أيام
- **Secure Cookies**: في بيئة الإنتاج فقط
- **SameSite**: 'lax' للحماية من CSRF

---

## 7. الاختبارات

### 7.1 أنواع الاختبارات

| النوع                 | العدد | الأداة     |
| --------------------- | ----- | ---------- |
| **Unit Tests**        | 20    | Vitest     |
| **Integration Tests** | 3     | Vitest     |
| **E2E Tests**         | 3     | Playwright |

### 7.2 تغطية الاختبارات

- **Services**: 85-90% تغطية
- **Routers**: 70-80% تغطية
- **Frontend**: 40-50% تغطية

---

## 8. النشر والتشغيل

### 8.1 متطلبات البيئة

- **Node.js**: 22+
- **pnpm**: 10+
- **MySQL/TiDB**: 8+
- **RAM**: 2GB+ (التطوير), 4GB+ (الإنتاج)
- **Storage**: 10GB+

### 8.2 متغيرات البيئة

المتغيرات الأساسية المطلوبة:

```env
DATABASE_URL=mysql://user:password@localhost:3306/ais
JWT_SECRET=your-jwt-secret
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### 8.3 أوامر التشغيل

```bash
# التطوير
pnpm dev

# البناء
pnpm build

# الإنتاج
pnpm start

# الاختبارات
pnpm test
```

---

## 9. الخلاصة

نظام AIS للطيران هو منصة شاملة ومتطورة تستخدم أحدث التقنيات وأفضل الممارسات. التوثيق الكامل متوفر في مجلد `docs/` ويشمل أدلة مفصلة للمطورين والإداريين.
